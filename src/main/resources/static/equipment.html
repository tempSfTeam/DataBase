<!doctype html>
<html>
<head>
    <meta charset="utf-8" />
    <title>设备管理 - Equipment</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <style>
        :root { --accent:#1f78ff; --muted:#6b7280; --bg:#f6f8fa; --card:#fff; }
        body { margin:0; font-family: -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial; background:var(--bg); color:#111; }
        header { background:linear-gradient(90deg,#fff,#f8fbff); padding:14px 20px; border-bottom:1px solid #e6eef8; box-shadow:0 2px 6px rgba(16,24,40,0.03); }
        header h1 { margin:0; font-size:18px; display:inline-block; }
        header nav { float:right; }
        header nav a { margin-left:12px; color:var(--accent); text-decoration:none; font-size:14px; }
        .container { max-width:1100px; margin:20px auto; padding:12px; }
        .row { display:flex; gap:12px; flex-wrap:wrap; }
        .card { background:var(--card); padding:14px; border-radius:8px; box-shadow:0 6px 20px rgba(16,24,40,0.04); flex:1 1 320px; }
        .card h2 { margin:0 0 8px 0; font-size:16px; }
        label { display:inline-block; margin:6px 8px 6px 0; font-size:13px; color:var(--muted); }
        input[type="text"], input[type="number"], select { padding:6px 8px; border:1px solid #dbe8ff; border-radius:6px; width:220px; }
        .btn { background:var(--accent); color:#fff; border:none; padding:8px 12px; border-radius:6px; cursor:pointer; }
        .btn.secondary { background:#f3f4f6; color:#111; border:1px solid #e5e7eb; }
        table { width:100%; border-collapse:collapse; margin-top:10px; }
        th, td { padding:8px; border-bottom:1px solid #eef2ff; text-align:left; font-size:14px; }
        th { background:#fbfdff; color:#333; font-weight:600; }
        .meta { margin-top:8px; color:var(--muted); font-size:13px; }
        .msg { margin-top:8px; color:green; }
        .err { margin-top:8px; color:#b91c1c; }
        .controls { display:flex; gap:8px; align-items:center; margin-top:8px; }
        .pager { display:flex; gap:8px; align-items:center; margin-left:auto; }
    </style>
</head>
<body>
<header>
    <h1>设备管理</h1>
    <nav>
        <a href="./index.html">首页</a>
        <a href="./workshop.html">车间</a>
        <a href="./maintenance_col.html">维修记录</a>
    </nav>
</header>

<div class="container">
    <div class="row">
        <div class="card" id="card-create">
            <h2>新增设备</h2>
            <div>
                <label>设备编号: <input id="create_deviceNo" type="text" /></label><br/>
                <label>型号: <input id="create_model" type="text" /></label><br/>
                <label>车间ID: <input id="create_workshopId" type="text" /></label><br/>
                <label>负责人: <input id="create_owner" type="text" /></label><br/>
                <label>状态: <select id="create_status"><option>IN_SERVICE</option><option>UNDER_MAINT</option><option>SCRAPPED</option></select></label><br/>
                <div style="margin-top:8px;">
                    <button class="btn" id="btnCreate">创建</button>
                    <span id="create_msg" class="msg"></span>
                </div>
            </div>
        </div>

        <div class="card" id="card-update">
            <h2>更新设备（按 deviceNo）</h2>
            <div>
                <label>设备编号 (必填): <input id="update_deviceNo" /></label><br/>
                <label>型号: <input id="update_model" /></label><br/>
                <label>车间ID: <input id="update_workshopId" /></label><br/>
                <label>负责人: <input id="update_owner" /></label><br/>
                <label>状态: <select id="update_status"><option></option><option>IN_SERVICE</option><option>UNDER_MAINT</option><option>SCRAPPED</option></select></label><br/>
                <div style="margin-top:8px;">
                    <button class="btn" id="btnUpdate">更新</button>
                    <span id="update_msg" class="msg"></span>
                </div>
            </div>
        </div>

        <div class="card" id="card-delete">
            <h2>删除设备</h2>
            <div>
                <label>设备编号: <input id="delete_deviceNo" /></label><br/>
                <div style="margin-top:8px;">
                    <button class="btn secondary" id="btnDelete">删除（需确认）</button>
                    <span id="delete_msg" class="err"></span>
                </div>
                <div class="meta">提示：只有状态为 SCRAPPED 的设备允许删除。</div>
            </div>
        </div>
    </div>

    <div class="card" style="margin-top:16px;">
        <h2>搜索设备（分页 + 筛选）</h2>
        <div>
            <label>型号: <input id="q_model" /></label>
            <label>车间ID: <input id="q_workshopId" /></label>
            <label>负责人: <input id="q_owner" /></label>
            <label>状态:
                <select id="q_status"><option value="">全部</option><option>IN_SERVICE</option><option>UNDER_MAINT</option><option>SCRAPPED</option></select>
            </label>
            <div style="margin-top:10px;">
                <button class="btn" id="btnSearch">搜索</button>
            </div>

            <div class="controls">
                <div class="meta">显示结果：</div>
                <div class="pager" style="margin-left:auto;">
                    <button class="btn secondary" id="prevPage">上一页</button>
                    <div id="pageInfo" class="meta">Page 1</div>
                    <button class="btn secondary" id="nextPage">下一页</button>
                </div>
            </div>

            <table id="resultTable">
                <thead>
                <tr>
                    <th>设备编号</th><th>型号</th><th>车间ID</th><th>负责人</th><th>状态</th><th>维修次数</th>
                </tr>
                </thead>
                <tbody></tbody>
            </table>
            <div id="search_msg" class="err"></div>
        </div>
    </div>
</div>

<script>
    const BASE = 'http://localhost:8089';
    const API = {
        create: BASE + '/equipments/create',
        update: BASE + '/equipments/update',
        delete: BASE + '/equipments/delete',
        search: BASE + '/equipments/searchWithCount'
    };

    function showMsg(el, text, ok=true){
        el.textContent = text || '';
        el.style.color = ok ? 'green' : '#b91c1c';
        setTimeout(()=>{ el.textContent = '' }, 4000);
    }

    async function postJson(url, body){
        const r = await fetch(url, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body) });
        if (!r.ok) throw new Error(await r.text());
        return r.json().catch(()=>null);
    }

    // Create
    document.getElementById('btnCreate').addEventListener('click', async ()=>{
        const dto = {
            deviceNo: document.getElementById('create_deviceNo').value.trim(),
            model: document.getElementById('create_model').value.trim(),
            workshopId: document.getElementById('create_workshopId').value.trim(),
            owner: document.getElementById('create_owner').value.trim(),
            status: document.getElementById('create_status').value
        };
        try {
            await postJson(API.create, dto);
            showMsg(document.getElementById('create_msg'), '创建成功');
            doSearch(1);
        } catch (e) {
            showMsg(document.getElementById('create_msg'), '创建失败: ' + e.message, false);
        }
    });

    // Update
    document.getElementById('btnUpdate').addEventListener('click', async ()=>{
        const dto = {
            deviceNo: document.getElementById('update_deviceNo').value.trim(),
            model: document.getElementById('update_model').value.trim(),
            workshopId: document.getElementById('update_workshopId').value.trim(),
            owner: document.getElementById('update_owner').value.trim(),
            status: document.getElementById('update_status').value
        };
        if (!dto.deviceNo) { showMsg(document.getElementById('update_msg'), 'deviceNo 必填', false); return; }
        try {
            await postJson(API.update, dto);
            showMsg(document.getElementById('update_msg'), '更新成功');
            doSearch(currentPage);
        } catch (e) {
            showMsg(document.getElementById('update_msg'), '更新失败: ' + e.message, false);
        }
    });

    // Delete with confirm
    document.getElementById('btnDelete').addEventListener('click', async ()=>{
        const deviceNo = document.getElementById('delete_deviceNo').value.trim();
        if (!deviceNo) { showMsg(document.getElementById('delete_msg'), '请输入设备编号', false); return; }
        if (!confirm('确认删除设备 ' + deviceNo + ' ?（仅 SCRAPPED 状态允许删除）')) return;
        try {
            await postJson(API.delete, { deviceNo });
            showMsg(document.getElementById('delete_msg'), '删除成功');
            doSearch(1);
        } catch (e) {
            showMsg(document.getElementById('delete_msg'), '删除失败: ' + e.message, false);
        }
    });

    // Search & pagination
    let currentPage = 1, pageSize = 10, total = 0;
    document.getElementById('btnSearch').addEventListener('click', ()=>doSearch(1));
    document.getElementById('prevPage').addEventListener('click', ()=>{ if (currentPage>1) doSearch(currentPage-1); });
    document.getElementById('nextPage').addEventListener('click', ()=>{ const max = Math.ceil(total/pageSize); if (currentPage<max) doSearch(currentPage+1); });

    async function doSearch(page){
        currentPage = page;
        const params = new URLSearchParams({
            page,
            size: pageSize,
            model: document.getElementById('q_model').value.trim(),
            workshopId: document.getElementById('q_workshopId').value.trim(),
            owner: document.getElementById('q_owner').value.trim(),
            status: document.getElementById('q_status').value
        });
        try {
            const r = await fetch(API.search + '?' + params.toString());
            if (!r.ok) throw new Error(await r.text());
            const data = await r.json();
            total = data.total || 0;
            renderTable(data.records || []);
            document.getElementById('pageInfo').textContent = `Page ${currentPage} / ${Math.max(1, Math.ceil(total/pageSize))} (Total ${total})`;
        } catch (e) {
            document.getElementById('search_msg').textContent = '搜索失败: ' + e.message;
        }
    }

    function renderTable(rows){
        const tbody = document.querySelector('#resultTable tbody');
        tbody.innerHTML = '';
        for (const r of rows){
            const tr = document.createElement('tr');
            tr.innerHTML = `<td>${escapeHtml(r.deviceNo)}</td>
                    <td>${escapeHtml(r.model)}</td>
                    <td>${escapeHtml(r.workshopId)}</td>
                    <td>${escapeHtml(r.owner)}</td>
                    <td>${escapeHtml(r.status)}</td>
                    <td>${r.maintenanceCount==null?0:r.maintenanceCount}</td>`;
            tbody.appendChild(tr);
        }
    }

    function escapeHtml(s){ if (s==null) return ''; return String(s).replace(/[&<>"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c])); }

    // initial load
    doSearch(1);
</script>
</body>
</html>