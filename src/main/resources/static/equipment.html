<!doctype html>
<html>
<head>
    <meta charset="utf-8" />
    <title>设备管理 - Equipment</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <style>
        :root { --accent:#1f78ff; --muted:#6b7280; --bg:#f6f8fa; --card:#fff; --danger:#ef4444; }
        body { margin:0; font-family: -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial; background:var(--bg); color:#111; }
        header { background:linear-gradient(90deg,#fff,#f8fbff); padding:14px 20px; border-bottom:1px solid #e6eef8; box-shadow:0 2px 6px rgba(16,24,40,0.03); display:flex; align-items:center; justify-content:space-between; }
        header h1 { margin:0; font-size:18px; }
        header nav a { margin-left:12px; color:var(--accent); text-decoration:none; }
        .container { max-width:1200px; margin:20px auto; padding:12px; }
        .row { display:flex; gap:12px; flex-wrap:wrap; }
        .card { background:var(--card); padding:14px; border-radius:8px; box-shadow:0 6px 20px rgba(16,24,40,0.04); flex:1 1 320px; }
        h2 { margin:0 0 8px 0; font-size:16px; }
        label { display:inline-block; margin:6px 8px 6px 0; color:var(--muted); font-size:13px; }
        input[type="text"], input[type="number"], input[type="date"], select, textarea { padding:6px 8px; border:1px solid #dbe8ff; border-radius:6px; width:220px; }
        textarea { width:360px; height:64px; vertical-align:top; resize:vertical; }
        .btn { background:var(--accent); color:#fff; border:none; padding:8px 12px; border-radius:6px; cursor:pointer; }
        .btn.secondary { background:#f3f4f6; color:#111; border:1px solid #e5e7eb; }
        .btn.danger { background:var(--danger); color:#fff; border:none; }
        table { width:100%; border-collapse:collapse; margin-top:10px; }
        th, td { padding:8px; border-bottom:1px solid #eef2ff; text-align:left; font-size:13px; vertical-align:top; }
        th { background:#fbfdff; color:#333; font-weight:600; }
        .meta { margin-top:8px; color:var(--muted); font-size:13px; }
        .msg { margin-top:8px; color:green; }
        .err { margin-top:8px; color:var(--danger); }
        .controls { display:flex; gap:8px; align-items:center; margin-top:8px; }
        .pager { display:flex; gap:8px; align-items:center; margin-left:auto; }
        .req-star { color: var(--danger); margin-left:4px; font-weight:700; }
        tr.clickable:hover { background:#f3f7ff; cursor:pointer; }
        .small { font-size:12px; color:var(--muted); }
        .field-group { margin-bottom:6px; }
    </style>
</head>
<body>
<header>
    <h1>设备管理</h1>
    <nav>
        <a href="./index.html">首页</a>
        <a href="./workshop.html">车间</a>
        <a href="./maintenance_col.html">维修记录</a>
    </nav>
</header>

<div class="container">

    <div class="row">
        <div class="card">
            <h2>新增设备</h2>

            <div class="field-group">
                <label>设备编号 <span class="req-star">*</span></label>
                <input id="create_deviceNo" type="text" />
            </div>

            <div class="field-group">
                <label>型号 <span class="req-star">*</span></label>
                <input id="create_model" type="text" />
            </div>

            <div class="field-group">
                <label>车间ID <span class="req-star">*</span></label>
                <input id="create_workshopId" type="text" />
            </div>

            <div class="field-group">
                <label>状态 <span class="req-star">*</span></label>
                <select id="create_status">
                    <option>IN_SERVICE</option>
                    <option>UNDER_MAINT</option>
                    <option>SCRAPPED</option>
                </select>
            </div>

            <hr />

            <div class="field-group">
                <label>厂商 (manufacturer)</label>
                <input id="create_manufacturer" type="text" />
            </div>

            <div class="field-group">
                <label>出厂日期 (manufactureDate)</label>
                <input id="create_manufactureDate" type="date" />
            </div>

            <div class="field-group">
                <label>购入日期 (purchaseDate)</label>
                <input id="create_purchaseDate" type="date" />
            </div>

            <div class="field-group">
                <label>购入价格 (purchasePrice)</label>
                <input id="create_purchasePrice" type="number" step="0.01" />
            </div>

            <div class="field-group">
                <label>负责人 (owner)</label>
                <input id="create_owner" type="text" />
            </div>

            <div class="field-group">
                <label>备注 (remark)</label>
                <textarea id="create_remark"></textarea>
            </div>

            <div style="margin-top:8px;">
                <button class="btn" id="btnCreate">创建</button>
                <span id="create_msg" class="msg"></span>
                <span id="create_err" class="err"></span>
            </div>
            <div class="small">标注 <span class="req-star">*</span> 的字段为必填。</div>
        </div>

        <div class="card">
            <h2>更新设备（点击搜索结果行可填充）</h2>

            <div class="field-group">
                <label>设备编号 (必填)</label>
                <input id="update_deviceNo" type="text" />
            </div>

            <div class="field-group">
                <label>型号</label>
                <input id="update_model" type="text" />
            </div>

            <div class="field-group">
                <label>车间ID</label>
                <input id="update_workshopId" type="text" />
            </div>

            <div class="field-group">
                <label>状态</label>
                <select id="update_status">
                    <option></option>
                    <option>IN_SERVICE</option>
                    <option>UNDER_MAINT</option>
                    <option>SCRAPPED</option>
                </select>
            </div>

            <hr />

            <div class="field-group">
                <label>厂商</label>
                <input id="update_manufacturer" type="text" />
            </div>

            <div class="field-group">
                <label>出厂日期</label>
                <input id="update_manufactureDate" type="date" />
            </div>

            <div class="field-group">
                <label>购入日期</label>
                <input id="update_purchaseDate" type="date" />
            </div>

            <div class="field-group">
                <label>购入价格</label>
                <input id="update_purchasePrice" type="number" step="0.01" />
            </div>

            <div class="field-group">
                <label>负责人</label>
                <input id="update_owner" type="text" />
            </div>

            <div class="field-group">
                <label>备注</label>
                <textarea id="update_remark"></textarea>
            </div>

            <div style="margin-top:8px;">
                <button class="btn" id="btnUpdate">更新</button>
                <button class="btn secondary" id="btnClear">清空表单</button>
                <button class="btn danger" id="btnDelete" style="margin-left:8px;">删除</button>
                <span id="update_msg" class="msg"></span>
                <span id="update_err" class="err"></span>
            </div>
        </div>
    </div>

    <div class="card" style="margin-top:16px;">
        <h2>搜索设备（分页 + 筛选）</h2>

        <div>
            <label>型号 (model): <input id="q_model" type="text" /></label>
            <label>车间ID (workshopId): <input id="q_workshopId" type="text" /></label>
            <label>负责人 (owner): <input id="q_owner" type="text" /></label>
            <label>状态 (status):
                <select id="q_status">
                    <option value="">全部</option>
                    <option>IN_SERVICE</option>
                    <option>UNDER_MAINT</option>
                    <option>SCRAPPED</option>
                </select>
            </label>
            <div style="margin-top:8px;">
                <button class="btn" id="btnSearch">搜索</button>
            </div>

            <div class="controls">
                <div class="meta">结果：</div>
                <div class="pager" style="margin-left:auto;">
                    <button class="btn secondary" id="prevPage">上一页</button>
                    <div id="pageInfo" class="meta">Page 1</div>
                    <button class="btn secondary" id="nextPage">下一页</button>
                </div>
            </div>

            <table id="resultTable">
                <thead>
                <tr>
                    <th>设备编号</th>
                    <th>型号</th>
                    <th>厂商</th>
                    <th>出厂日期</th>
                    <th>购入日期</th>
                    <th>购入价格</th>
                    <th>车间ID</th>
                    <th>负责人</th>
                    <th>状态</th>
                    <th>备注</th>
                    <th>维修次数</th>
                </tr>
                </thead>
                <tbody></tbody>
            </table>

            <div id="search_msg" class="err"></div>
        </div>
    </div>

</div>

<script>
    const BASE = 'http://localhost:8089';
    const API = {
        create: BASE + '/equipments/create',
        update: BASE + '/equipments/update',
        delete: BASE + '/equipments/delete',
        search: BASE + '/equipments/searchWithCount'
    };

    function showMsg(el, text, ok=true){
        el.textContent = text || '';
        el.style.color = ok ? 'green' : 'var(--danger)';
        if (text) setTimeout(()=> { el.textContent = '' }, 4000);
    }

    async function postJson(url, body){
        const r = await fetch(url, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(body)
        });
        if (!r.ok) {
            const txt = await r.text();
            throw new Error(txt || r.statusText);
        }
        return r.json().catch(()=>null);
    }

    // Create
    document.getElementById('btnCreate').addEventListener('click', async () => {
        const errEl = document.getElementById('create_err');
        errEl.textContent = '';
        const deviceNo = document.getElementById('create_deviceNo').value.trim();
        const model = document.getElementById('create_model').value.trim();
        const workshopId = document.getElementById('create_workshopId').value.trim();
        const status = document.getElementById('create_status').value;

        if (!deviceNo) { showMsg(errEl, 'deviceNo 为必填', false); return; }
        if (!model) { showMsg(errEl, 'model 为必填', false); return; }
        if (!workshopId) { showMsg(errEl, 'workshopId 为必填', false); return; }
        if (!status) { showMsg(errEl, 'status 为必填', false); return; }

        const body = {
            deviceNo,
            model,
            manufacturer: document.getElementById('create_manufacturer').value.trim() || null,
            manufactureDate: document.getElementById('create_manufactureDate').value || null,
            purchaseDate: document.getElementById('create_purchaseDate').value || null,
            purchasePrice: document.getElementById('create_purchasePrice').value ? parseFloat(document.getElementById('create_purchasePrice').value) : null,
            workshopId,
            owner: document.getElementById('create_owner').value.trim() || null,
            status,
            remark: document.getElementById('create_remark').value.trim() || null
        };

        try {
            await postJson(API.create, body);
            showMsg(document.getElementById('create_msg'), '创建成功');
            doSearch(1);
        } catch (e) {
            showMsg(errEl, '创建失败: ' + e.message, false);
        }
    });

    // Update
    document.getElementById('btnUpdate').addEventListener('click', async () => {
        const errEl = document.getElementById('update_err');
        errEl.textContent = '';
        const deviceNo = document.getElementById('update_deviceNo').value.trim();
        if (!deviceNo) { showMsg(errEl, 'deviceNo 必填', false); return; }

        const body = {
            deviceNo,
            model: document.getElementById('update_model').value.trim() || null,
            manufacturer: document.getElementById('update_manufacturer').value.trim() || null,
            manufactureDate: document.getElementById('update_manufactureDate').value || null,
            purchaseDate: document.getElementById('update_purchaseDate').value || null,
            purchasePrice: document.getElementById('update_purchasePrice').value ? parseFloat(document.getElementById('update_purchasePrice').value) : null,
            workshopId: document.getElementById('update_workshopId').value.trim() || null,
            owner: document.getElementById('update_owner').value.trim() || null,
            status: document.getElementById('update_status').value || null,
            remark: document.getElementById('update_remark').value.trim() || null
        };

        try {
            await postJson(API.update, body);
            showMsg(document.getElementById('update_msg'), '更新成功');
            doSearch(currentPage);
        } catch (e) {
            showMsg(errEl, '更新失败: ' + e.message, false);
        }
    });

    document.getElementById('btnClear').addEventListener('click', () => {
        // Clear update form
        ['update_deviceNo','update_model','update_manufacturer','update_manufactureDate','update_purchaseDate','update_purchasePrice','update_workshopId','update_owner','update_status','update_remark'].forEach(id => {
            const el = document.getElementById(id);
            if (el) el.value = '';
        });
        document.getElementById('update_msg').textContent = '';
        document.getElementById('update_err').textContent = '';
    });

    // Delete
    document.getElementById('btnDelete').addEventListener('click', async () => {
        const errEl = document.getElementById('update_err');
        errEl.textContent = '';
        const deviceNo = document.getElementById('update_deviceNo').value.trim();
        if (!deviceNo) { showMsg(errEl, '请输入要删除的 deviceNo', false); return; }
        if (!confirm('确认删除设备 ' + deviceNo + ' ? 该操作将永久删除设备信息（维修记录不会被级联删除）。')) return;
        try {
            await postJson(API.delete, { deviceNo });
            showMsg(document.getElementById('update_msg'), '删除成功');
            // clear form and refresh list
            document.getElementById('btnClear').click();
            doSearch(1);
        } catch (e) {
            showMsg(errEl, '删除失败: ' + e.message, false);
        }
    });

    // Search & pagination
    let currentPage = 1, pageSize = 10, total = 0;
    document.getElementById('btnSearch').addEventListener('click', ()=> doSearch(1));
    document.getElementById('prevPage').addEventListener('click', ()=> { if (currentPage>1) doSearch(currentPage-1); });
    document.getElementById('nextPage').addEventListener('click', ()=> { if (currentPage < Math.ceil(total/pageSize)) doSearch(currentPage+1); });

    async function doSearch(page){
        currentPage = page;
        const params = new URLSearchParams({
            page,
            size: pageSize,
            model: document.getElementById('q_model').value.trim(),
            workshopId: document.getElementById('q_workshopId').value.trim(),
            owner: document.getElementById('q_owner').value.trim(),
            status: document.getElementById('q_status').value
        });
        try {
            const r = await fetch(API.search + '?' + params.toString());
            if (!r.ok) throw new Error(await r.text());
            const data = await r.json();
            total = data.total || 0;
            renderTable(data.records || []);
            document.getElementById('pageInfo').textContent = `Page ${currentPage} / ${Math.max(1, Math.ceil(total/pageSize))} (Total ${total})`;
        } catch (e) {
            document.getElementById('search_msg').textContent = '搜索失败: ' + e.message;
        }
    }

    function renderTable(rows){
        const tbody = document.querySelector('#resultTable tbody');
        tbody.innerHTML = '';
        for (const r of rows){
            const tr = document.createElement('tr');
            tr.className = 'clickable';
            tr.innerHTML = `<td>${escapeHtml(r.deviceNo)}</td>
                    <td>${escapeHtml(r.model)}</td>
                    <td>${escapeHtml(r.manufacturer || '')}</td>
                    <td>${escapeHtml(r.manufactureDate || '')}</td>
                    <td>${escapeHtml(r.purchaseDate || '')}</td>
                    <td>${r.purchasePrice!=null?escapeHtml(r.purchasePrice):''}</td>
                    <td>${escapeHtml(r.workshopId || '')}</td>
                    <td>${escapeHtml(r.owner || '')}</td>
                    <td>${escapeHtml(r.status || '')}</td>
                    <td>${escapeHtml(r.remark || '')}</td>
                    <td>${r.maintenanceCount==null?0:r.maintenanceCount}</td>`;
            tr.addEventListener('click', ()=> fillUpdateForm(r));
            tbody.appendChild(tr);
        }
    }

    function fillUpdateForm(r){
        document.getElementById('update_deviceNo').value = r.deviceNo || '';
        document.getElementById('update_model').value = r.model || '';
        document.getElementById('update_manufacturer').value = r.manufacturer || '';
        // For dates: if backend returns LocalDate as 'YYYY-MM-DD' or with time, try to keep safe
        document.getElementById('update_manufactureDate').value = r.manufactureDate ? r.manufactureDate.substring(0,10) : '';
        document.getElementById('update_purchaseDate').value = r.purchaseDate ? r.purchaseDate.substring(0,10) : '';
        document.getElementById('update_purchasePrice').value = r.purchasePrice != null ? r.purchasePrice : '';
        document.getElementById('update_workshopId').value = r.workshopId || '';
        document.getElementById('update_owner').value = r.owner || '';
        document.getElementById('update_status').value = r.status || '';
        document.getElementById('update_remark').value = r.remark || '';
    }

    function escapeHtml(s){ if (s==null) return ''; return String(s).replace(/[&<>"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c])); }

    // initial load
    doSearch(1);
</script>
</body>
</html>